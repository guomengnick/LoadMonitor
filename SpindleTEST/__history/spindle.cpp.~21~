// ---------------------------------------------------------------------------

#include <vcl.h>
#include <IniFiles.hpp>
#include <random>
#include <ctime>
#pragma hdrstop

#include "spindle.h"
// ---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm1 *Form1;

// ---------------------------------------------------------------------------
__fastcall TForm1::TForm1(TComponent* Owner) : TForm(Owner)
{

	UpdateTimer->Interval = 1000; // 設定為 1000ms
	UpdateTimer->OnTimer = UpdateSpindleInfo; // 設定 Timer 的觸發函數

}
// ---------------------------------------------------------------------------



int GenerateRandomInt(int base, int range)
{
	return base + (std::rand() % (2 * range + 1)) - range;
}

double GenerateRandomDouble(double base, double range)
{
	double scale = static_cast<double>(std::rand()) / RAND_MAX;
	return base - range + scale * (2 * range);
}


String GenerateRandomStatus()
{
	int randomValue = std::rand() % 100; // 生成 0 到 99 的隨機整數

	if (randomValue < 5)
	{
		return "STOP";//L"停止"; // 停止機率為 5%
	}
	else if (randomValue < 55)
	{
		return "Idle";//L"怠速"; // 怠速機率為 50%
	}
	else
	{
		return "Run";//L"運轉"; // 運轉機率為 45%
	}
}


void __fastcall TForm1::UpdateSpindleInfo(TObject *Sender)
{
	// 設定 INI 檔案的路徑
	String iniFilePath = ExtractFilePath(Application->ExeName) + "spindle_info.ini";

	// 建立 TMemIniFile，這裡不直接指定編碼
	std::unique_ptr<TMemIniFile>ini(new TMemIniFile(iniFilePath));

	try
	{
		// 隨機生成數值
		int speed = GenerateRandomInt(37500, 15000); // Speed
		String status = GenerateRandomStatus(); // Status
		String internalStatus = GenerateRandomStatus(); // InternalStatus
		int power = GenerateRandomInt(5000, 1000); // Power
		double busVoltage = GenerateRandomDouble(48.0, 1.0); // BusVoltage
		double current = GenerateRandomDouble(1.0, 0.15); // Current
		int motorTemperature = GenerateRandomInt(40, 10); // MotorTemperature
		double inverterTemperature = GenerateRandomDouble(30.4, 5.0); // InverterTemperature

		// 更新 INI 檔案內容（存儲到記憶體）
		ini->WriteInteger("Spindle", "Speed", speed);
		ini->WriteString("Spindle", "Status", status);
		ini->WriteString("Spindle", "InternalStatus", internalStatus);
		ini->WriteInteger("Spindle", "Power", power);
		ini->WriteFloat("Spindle", "BusVoltage", busVoltage);
		ini->WriteFloat("Spindle", "Current", current);
		ini->WriteInteger("Spindle", "MotorTemperature", motorTemperature);
		ini->WriteFloat("Spindle", "InverterTemperature", inverterTemperature);

		// 將記憶體內容保存到檔案（共享模式）
		TStringList *iniContent = new TStringList();
		try
		{
			// 將 TMemIniFile 的內容導出到 TStringList
			ini->GetStrings(iniContent);

			// 寫入檔案時使用共享模式
			TFileStream *fileStream = new TFileStream(iniFilePath, fmCreate | fmShareDenyNone);
			try
			{
				iniContent->SaveToStream(fileStream);
			}
			__finally
			{
				delete fileStream;
			}
		}
		__finally
		{
			delete iniContent;
		}
	}
	__finally
	{
		// 保證不留下任何未釋放的資源
	}
}


void __fastcall TForm1::CheckBox_UpdateSpindleInfoClick(TObject *Sender)
{


	if (CheckBox_UpdateSpindleInfo->Checked)
	{
		UpdateTimer->Enabled = true; // 開啟 Timer
	}
	else
	{
		UpdateTimer->Enabled = false; // 關閉 Timer
	}
}
// ---------------------------------------------------------------------------
